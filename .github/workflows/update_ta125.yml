name: ğŸ‡®ğŸ‡± Update TA125 Data

on:
  # Run daily at 02:00 UTC (5:00 AM Israel time)
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  update-ta125:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 1 hour timeout
    
    steps:
    - name: ğŸ›ï¸ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: ğŸ“ Create Public Directory
      run: |
        mkdir -p public
        ls -la
        
    - name: ğŸ‡®ğŸ‡± Fetch TA125 Stock Data
      run: |
        echo "ğŸ‡®ğŸ‡± Starting TA125 data fetch using Yahoo Finance HTTP API..."
        echo "ğŸ“… Current time: $(date -u)"
        echo "ğŸ“Š Processing TA125 symbols from TASE"
        
        # Run the Python script
        python fetch_ta125_data.py
        
        echo "ğŸ“‹ Files in public directory:"
        ls -la public/
        
        if [ -f "public/ta125_ohlcv_latest.json" ]; then
          echo "âœ… TA125 JSON file created successfully"
          echo "ğŸ“Š File size: $(du -h public/ta125_ohlcv_latest.json | cut -f1)"
          
          # Show basic file info
          python -c "
import json
import os
try:
    with open('public/ta125_ohlcv_latest.json', 'r') as f:
        data = json.load(f)
        print(f'ğŸ“ˆ Total symbols: {data.get(\"total_symbols\", 0)}')
        print(f'âœ… Successful: {data.get(\"successful_symbols\", 0)}')
        print(f'ğŸ’± Currency: {data.get(\"currency\", \"ILS\")}')
        print(f'ğŸ¢ Exchange: {data.get(\"exchange\", \"TASE\")}')
        
        # Check file size
        file_size = os.path.getsize('public/ta125_ohlcv_latest.json')
        print(f'ğŸ“¦ File size: {file_size:,} bytes')
        
        if file_size < 1000:  # Less than 1KB indicates problem
            print('âš ï¸ Warning: File size seems too small')
            exit(1)
except Exception as e:
    print(f'âŒ Error reading JSON file: {e}')
    exit(1)
"
        else
          echo "âŒ TA125 JSON file not found!"
          echo "ğŸ“‹ Contents of public directory:"
          find public/ -type f -exec ls -la {} \;
          exit 1
        fi
    
    - name: ğŸ“„ Copy HTML Files to Public
      run: |
        # Copy the HTML files to public directory
        if [ -f "index.html" ]; then
          cp index.html public/
          echo "âœ… Copied index.html to public/"
        fi
        
        echo "ğŸ“‹ Final public directory contents:"
        ls -la public/
    
    - name: ğŸ”§ Setup Node.js for Firebase
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ Install Firebase CLI
      run: |
        npm install -g firebase-tools
        firebase --version
    
    - name: ğŸ”¥ Deploy to Firebase Hosting
      run: |
        echo "ğŸš€ Deploying TA125 data to Firebase Hosting..."
        echo "ğŸ“ Deploying from public/ directory"
        
        # Deploy using Firebase token
        firebase deploy --only hosting --token "$FIREBASE_TOKEN" --non-interactive --project "$FIREBASE_PROJECT_ID"
        
        echo "âœ… Firebase deployment complete!"
        echo "ğŸŒ TA125 API URL: https://$FIREBASE_PROJECT_ID.web.app/ta125_ohlcv_latest.json"
        echo "ğŸ  Website URL: https://$FIREBASE_PROJECT_ID.web.app/"
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
    
    - name: ğŸ§ª Test API Endpoint
      run: |
        echo "ğŸ§ª Testing deployed API endpoint..."
        sleep 10  # Wait for deployment to propagate
        
        # Test the API endpoint
        API_URL="https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app/ta125_ohlcv_latest.json"
        
        echo "ğŸ“¡ Testing: $API_URL"
        
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL")
        
        if [ "$HTTP_STATUS" = "200" ]; then
          echo "âœ… API endpoint is responding correctly (HTTP $HTTP_STATUS)"
          
          # Test JSON validity
          curl -s "$API_URL" | python -c "
import json, sys
try:
    data = json.load(sys.stdin)
    print(f'âœ… JSON is valid')
    print(f'ğŸ“Š Symbols in API: {data.get(\"successful_symbols\", 0)}')
    print(f'ğŸ“… Last updated: {data.get(\"last_updated\", \"Unknown\")}')
except Exception as e:
    print(f'âŒ JSON validation failed: {e}')
    exit(1)
"
        else
          echo "âŒ API endpoint test failed (HTTP $HTTP_STATUS)"
          exit 1
        fi
    
    - name: ğŸ“Š Final Summary Report
      if: always()
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                    ğŸ‡®ğŸ‡± TA125 DEPLOYMENT SUMMARY                  â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "â° Completed at: $(date -u)"
        echo "ğŸ‡®ğŸ‡± Market: TA125 (Tel Aviv Stock Exchange)"
        echo "ğŸ’» Python Version: $(python --version)"
        echo "ğŸ”¥ Firebase CLI: $(firebase --version)"
        echo ""
        
        if [ -f "public/ta125_ohlcv_latest.json" ]; then
          python -c "
import json
import os
from datetime import datetime

try:
    with open('public/ta125_ohlcv_latest.json', 'r') as f:
        data = json.load(f)
        
    total = data.get('total_symbols', 0)
    success = data.get('successful_symbols', 0) 
    rate = (success/total*100) if total > 0 else 0
    
    print(f'ğŸ“ˆ Processed: {success}/{total} symbols ({rate:.1f}% success rate)')
    print(f'ğŸ’± Currency: {data.get(\"currency\", \"ILS\")}')
    print(f'ğŸ¢ Exchange: {data.get(\"exchange\", \"TASE\")}')
    print(f'ğŸ”„ Data Source: {data.get(\"data_source\", \"Yahoo Finance\")}')
    
    if data.get('failed_symbols'):
        failed_count = len(data['failed_symbols'])
        print(f'âŒ Failed: {failed_count} symbols')
        if failed_count <= 5:
            print(f'   Failed symbols: {data[\"failed_symbols\"]}')
        else:
            print(f'   First 5 failed: {data[\"failed_symbols\"][:5]}...')
    
    # File info
    file_size = os.path.getsize('public/ta125_ohlcv_latest.json')
    print(f'ğŸ“¦ JSON file size: {file_size:,} bytes ({file_size/1024:.1f} KB)')
    
    # Last updated
    if data.get('last_updated'):
        try:
            updated_time = datetime.fromisoformat(data['last_updated'].replace('Z', '+00:00'))
            print(f'ğŸ• Last updated: {updated_time.strftime(\"%Y-%m-%d %H:%M:%S UTC\")}')
        except:
            print(f'ğŸ• Last updated: {data[\"last_updated\"]}')
            
except Exception as e:
    print(f'âŒ Error reading TA125 summary: {e}')
"
        else
          echo "âŒ TA125 JSON file not found in final check"
        fi
        
        echo ""
        echo "ğŸŒ API Endpoints:"
        echo "   ğŸ“Š JSON Data: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app/ta125_ohlcv_latest.json"
        echo "   ğŸ  Website: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app/"
        echo ""
        echo "ğŸ“± Ready for Flutter app integration!"
        echo "ğŸ”„ Next update: Tomorrow at 02:00 UTC"
        echo ""
        
    - name: ğŸ“ Create Deployment Artifact
      if: success()
      run: |
        # Create a summary file for the deployment
        cat > deployment-summary.txt << EOF
TA125 Deployment Summary
========================
Date: $(date -u)
Status: Success âœ…
API URL: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app/ta125_ohlcv_latest.json
Website: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app/

$(python -c "
import json
try:
    with open('public/ta125_ohlcv_latest.json', 'r') as f:
        data = json.load(f)
    print(f'Symbols: {data.get(\"successful_symbols\", 0)}/{data.get(\"total_symbols\", 0)}')
    print(f'Success Rate: {(data.get(\"successful_symbols\", 0)/data.get(\"total_symbols\", 1)*100):.1f}%')
except:
    print('Data summary unavailable')
")
EOF
        
    - name: ğŸ“¤ Upload Deployment Summary
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: ta125-deployment-summary
        path: |
          public/ta125_ohlcv_latest.json
          deployment-summary.txt
        retention-days: 7
