name: Update TA125 Data

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update-ta125:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Create Public Directory
      run: mkdir -p public
        
    - name: Run TA125 Data Fetcher
      run: python fetch_ta125_data.py
        
    - name: Verify JSON File
      run: |
        if [ -f "public/ta125_ohlcv_latest.json" ]; then
          echo "JSON file created successfully"
          ls -la public/ta125_ohlcv_latest.json
        else
          echo "ERROR: JSON file not found"
          exit 1
        fi
    
    - name: Copy HTML to Public
      run: |
        if [ -f "index.html" ]; then
          cp index.html public/
        fi
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
    
    - name: Deploy to Firebase
      run: firebase deploy --only hosting --token "$FIREBASE_TOKEN" --non-interactive
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
    
    - name: Test API Endpoint
      run: |
        if [ -n "${{ secrets.FIREBASE_PROJECT_ID }}" ]; then
          sleep 10
          API_URL="https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app/ta125_ohlcv_latest.json"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL")
          echo "API Status: $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ]; then
            echo "SUCCESS: API is live"
          else
            echo "WARNING: API returned $HTTP_CODE"
          fi
        fi
    
    - name: Summary
      if: always()
      run: |
        echo "TA125 Deployment Complete"
        echo "Time: $(date -u)"
        if [ -f "public/ta125_ohlcv_latest.json" ]; then
          echo "Status: SUCCESS"
        else
          echo "Status: FAILED"
        fi
