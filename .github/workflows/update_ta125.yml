name: ğŸ‡®ğŸ‡± Update TA125 Data

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update-ta125:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ğŸ›ï¸ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: ğŸ“ Setup Directories
      run: |
        mkdir -p public
        ls -la
        
    - name: ğŸ‡®ğŸ‡± Fetch TA125 Data
      run: |
        echo "ğŸ‡®ğŸ‡± Starting TA125 data fetch..."
        echo "ğŸ“… Time: $(date -u)"
        python fetch_ta125_data.py
        
    - name: âœ… Validate JSON Output
      run: |
        echo "ğŸ“‹ Checking generated files..."
        ls -la public/
        
        if [ -f "public/ta125_ohlcv_latest.json" ]; then
          echo "âœ… JSON file exists"
          echo "ğŸ“Š Size: $(du -h public/ta125_ohlcv_latest.json)"
          
          # Validate JSON syntax
          python -c "import json; json.load(open('public/ta125_ohlcv_latest.json'))"
          echo "âœ… JSON syntax is valid"
          
          # Check file size
          SIZE=$(stat -f%z public/ta125_ohlcv_latest.json 2>/dev/null || stat -c%s public/ta125_ohlcv_latest.json)
          if [ "$SIZE" -lt 1000 ]; then
            echo "âŒ File too small: ${SIZE} bytes"
            exit 1
          fi
          echo "âœ… File size OK: ${SIZE} bytes"
          
        else
          echo "âŒ JSON file not found!"
          exit 1
        fi
    
    - name: ğŸ“„ Copy HTML Files
      run: |
        if [ -f "index.html" ]; then
          cp index.html public/
          echo "âœ… Copied index.html"
        fi
        echo "ğŸ“‹ Final contents:"
        ls -la public/
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: ğŸ“¦ Install Firebase CLI
      run: |
        npm install -g firebase-tools
        firebase --version
    
    - name: ğŸš€ Deploy to Firebase
      run: |
        echo "ğŸš€ Deploying to Firebase..."
        firebase deploy --only hosting --token "$FIREBASE_TOKEN" --non-interactive
        echo "âœ… Deployment complete!"
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
    
    - name: ğŸ§ª Test Deployment
      run: |
        echo "ğŸ§ª Testing API endpoint..."
        sleep 5
        
        if [ -n "${{ secrets.FIREBASE_PROJECT_ID }}" ]; then
          API_URL="https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app/ta125_ohlcv_latest.json"
          echo "ğŸ“¡ Testing: $API_URL"
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL")
          echo "HTTP Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… API endpoint is live!"
          else
            echo "âš ï¸ API returned HTTP $HTTP_CODE"
          fi
        else
          echo "âš ï¸ FIREBASE_PROJECT_ID not set, skipping endpoint test"
        fi
    
    - name: ğŸ“Š Summary Report
      if: always()
      run: |
        echo ""
        echo "ğŸ‡®ğŸ‡± TA125 DEPLOYMENT SUMMARY"
        echo "============================="
        echo "â° Completed: $(date -u)"
        echo ""
        
        if [ -f "public/ta125_ohlcv_latest.json" ]; then
          echo "âœ… JSON file: EXISTS"
          
          python -c "
import json
try:
    with open('public/ta125_ohlcv_latest.json') as f:
        data = json.load(f)
    total = data.get('total_symbols', 0)
    success = data.get('successful_symbols', 0)
    rate = (success/total*100) if total > 0 else 0
    print(f'ğŸ“ˆ Symbols: {success}/{total} ({rate:.1f}%)')
    print(f'ğŸ’± Currency: {data.get(\"currency\", \"ILS\")}')
    print(f'ğŸ¢ Exchange: {data.get(\"exchange\", \"TASE\")}')
except Exception as e:
    print(f'âŒ Error: {e}')
"
        else
          echo "âŒ JSON file: MISSING"
        fi
        
        if [ -n "${{ secrets.FIREBASE_PROJECT_ID }}" ]; then
          echo ""
          echo "ğŸŒ URLs:"
          echo "   API: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app/ta125_ohlcv_latest.json"
          echo "   Web: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app/"
        fi
        
        echo ""
        echo "ğŸ”„ Next update: Tomorrow at 02:00 UTC"
